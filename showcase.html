<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="format-detection" content="telephone=no" />
    <title>canvas hdmi</title>

    <style>
        .hidden {
            display: none;
        }

        * {
            padding: 0;
            margin: 0;
        }

        h5 {
            padding-left: 10px;
            margin-bottom: 10px;
        }

        #canvas,
        #unrepair {
            display: block;
            margin: 0 auto;
        }

        button {
            margin-top: 10px;
            margin-left: 10px;
            padding: 8px;
            background-color: #428bca;
            border-color: #357ebd;
            color: #fff;
            border-radius: 10px;
            margin-bottom: 15px;
            -khtml-border-radius: 10px;
            text-align: center;
            vertical-align: middle;
            border: 1px solid transparent;
            font-size: 14px;
        }
    </style>
</head>

<body>
    <button id="selectbtn">选择图片</button>

    <h5>未修正的图片：</h5>
    <canvas id="uncorrected"></canvas>

    <h5>修正过后的图片：</h5>
    <canvas id="corrected"></canvas>

    <input type="file" class="hidden" id="upload">
    
    <script src="./dist/emiya-canvas.min.js"></script>

    <script>
        const uploadEl = document.getElementById('upload');

        // 修复过后的 canvas 元素
        const correctedEl = document.getElementById('corrected');

        // 未经过修复的 canvas 元素
        const uncorrectedEl = document.getElementById('uncorrected'),
            uncorrectedCtx = uncorrectedEl.getContext('2d');

        const emiya = new EmiyaCanvas();

        document.getElementById('selectbtn').addEventListener('click', function () {
            uploadEl.click();
        });

        uploadEl.addEventListener('change', function () {
            const file = this.files[0];

            // 未经过处理绘图
            unrepair(file);

            // 设置文件
            emiya.setFile(file);

            // 渲染画布
            emiya.render(correctedEl, {
                width: 300,
                quality: .8
            }, function(response) {
                console.log(response);
            });
        });

        /**
         * 未经过处理绘图
         * 与处理过后的图片做个对比看下效果
         * @param {Object} file 文件对象
         */
        function unrepair(file) {
            let fileReader = new FileReader();

            fileReader.readAsDataURL(file);
            fileReader.onload = function (e) {
                const img = new Image();

                img.src = e.target.result;
                img.onload = function () {
                    const imgWidth = img.width,
                        imgHeight = img.height;

                    let canvasWidth = imgWidth,
                        canvasHeight = imgHeight;

                    if (imgWidth > 300 || imgHeight > window.screen.height) {
                        if (imgWidth > 300) {
                            canvasWidth = 300;
                            canvasHeight = canvasWidth * imgHeight / imgWidth;
                        } else if (imgHeight > window.screen.height) {
                            canvasHeight = window.screen.height;
                            canvasWidth = imgWidth * canvasHeight / imgHeight;
                        }
                    }

                    uncorrectedEl.width = canvasWidth;
                    uncorrectedEl.height = canvasHeight;
                    uncorrectedEl.style.cssText = 'width: ' + canvasWidth + 'px; height: ' + canvasHeight +
                        'px';

                    uncorrectedCtx.drawImage(this, 0, 0, canvasWidth, canvasHeight);
                };
            };
        }
    </script>
</body>

</html>